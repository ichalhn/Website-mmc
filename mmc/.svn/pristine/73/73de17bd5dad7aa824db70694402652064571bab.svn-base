<?php
defined('BASEPATH') OR exit('No direct script access allowed');
require_once(APPPATH.'controllers/Secure_area.php');
include('Frmcterbilang.php');
class Frmcstok extends Secure_area
{
  public function __construct(){
	parent::__construct();
	$this->load->model('logistik_farmasi/Frmmtransaksi','',TRUE);
  $this->load->model('logistik_farmasi/Frmmpemasok','',TRUE);
  $this->load->model('logistik_farmasi/Frmmdistribusi','',TRUE);
  $this->load->model('logistik_farmasi/Frmmstok','',TRUE);
	$this->load->model('master/Mmobat','',TRUE);
  $this->load->helper('pdf_helper');
	}

  function index()
	{
    $data['title'] = 'Stok Barang';
    $data['select_gudang'] = $this->Frmmstok->get_data_gudang()->result();

    $login_data = $this->load->get_var("user_info");
    $data['roleid'] = $this->Frmmstok->get_roleid($login_data->userid)->row()->roleid;

    $id_gudang = $this->Frmmstok->get_gudangid($login_data->userid)->result();
    $i=1;

    foreach ($id_gudang as $row) {
      if($i==1){
        $gd = $this->Frmmstok->getdata_gudang_inventory_by_role($row->id_gudang)->result();
      }else {
        $gd = array_merge($gd, $this->Frmmstok->getdata_gudang_inventory_by_role($row->id_gudang)->result());
      }
    
      $i++;
    }
    $data['data_barang'] = $gd;
	  $this->load->view('logistik_farmasi/Frmvdaftarstok',$data);
	}

  function index2()
  {
    $data['title'] = 'Stok Barang';
    $data['select_gudang'] = $this->Frmmstok->get_data_gudang()->result();
    $data['data_barang'] = $this->Frmmstok->getdata_gudang_inventory()->result();
    
    $this->load->view('logistik_farmasi/Frmvlapstok',$data);
  }

  public function get_data_detail_gudang(){
    $nm_gudang=$this->input->post('nm_gudang');
    $datajson=$this->Frmmdistribusi->getdata_gudang_inventory($nm_gudang)->result();
    echo json_encode($datajson);
  }

  public function exceldown($nm_gudang){
    $data['title'] = 'Laporan Gudang Muara';
    $nm_gudangreal=str_ireplace("%20"," ",$nm_gudang);    
    $namars=$this->config->item('namars');
    $alamat=$this->config->item('alamat');
    $kota_kab=$this->config->item('kota');
      
    $nm_gudang=$this->input->post('nm_gudang');
    $datajson=$this->Frmmstok->get_data_gudang_detail($nm_gudangreal)->result();
    //print_r($datajson);break;
    ////EXCEL 
    $this->load->library('Excel');  
       
    // Create new PHPExcel object  
    $objPHPExcel = new PHPExcel();
    
    $objPHPExcel->getProperties()->setCreator($namars)  
            ->setLastModifiedBy($namars)  
            ->setTitle("Laporan Gudang Muara ".$namars)  
            ->setSubject("Laporan Gudang Muara ".$namars." Document")  
            ->setDescription("Laporan Gudang Muara ".$namars." for Office 2007 XLSX, generated by HMIS.")  
            ->setKeywords($namars)  
            ->setCategory("Laporan Gudang Muara");  
    
    $objReader= PHPExcel_IOFactory::createReader('Excel2007');
    $objReader->setReadDataOnly(true);
    $date=date('Y-m-d');
        $date_title=date('d F Y', strtotime($date));     
      
    $objPHPExcel=$objReader->load(APPPATH.'third_party/log_farm_stok_gudang.xlsx');
        // Set active sheet index to the first sheet, so Excel opens this as the first sheet  
    $objPHPExcel->setActiveSheetIndex(0);  
        // Add some data  
    $objPHPExcel->getActiveSheet()->SetCellValue('A1', $data['title'].' '.$nm_gudangreal);
    $objPHPExcel->getActiveSheet()->SetCellValue('A2', 'Tanggal : '.$date_title);
    
    $i=1;
    $rowCount = 5;$qtytot=0;
    foreach($datajson as $row){
      $qtytot+=$row->qty;
      $objPHPExcel->getActiveSheet()->SetCellValue('A'.$rowCount, $i);
      $objPHPExcel->getActiveSheet()->SetCellValue('B'.$rowCount, $row->batch_no);
      //SetCellValue('B'.$rowCount, $row->no_medrec);
      $objPHPExcel->getActiveSheet()->SetCellValue('C'.$rowCount, $row->nm_obat);
      $objPHPExcel->getActiveSheet()->SetCellValue('D'.$rowCount, $row->qty);
      $objPHPExcel->getActiveSheet()->SetCellValue('E'.$rowCount, $row->expire_date);
      $i++;
      
      $rowCount++;
    }
    
    $objPHPExcel->getActiveSheet()->SetCellValue('C'.$rowCount, 'Total');
        $objPHPExcel->getActiveSheet()->SetCellValue('D'.$rowCount, $qtytot);
        $objPHPExcel->getActiveSheet()->getStyle('D'.$rowCount)->applyFromArray(
            array(
          'fill' => array(
              'type' => PHPExcel_Style_Fill::FILL_SOLID,
              'color' => array('rgb' => 'C1B2B2')
          )
            )
        );
        
          
        
    header('Content-Disposition: attachment;filename="Excel_Gudang_'.$date.'_'.$nm_gudangreal.'.xlsx"');  
        
    $objPHPExcel->getActiveSheet()->setTitle($namars);  
                   
    // Redirect output to a client’s web browser (Excel2007)  
    //clean the output buffer  
    ob_end_clean();  
       
    //this is the header given from PHPExcel examples.   
    //but the output seems somewhat corrupted in some cases.  
    //header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');  
    //so, we use this header instead.  
    header('Content-type: application/vnd.ms-excel');  
    header('Cache-Control: max-age=0');  
       
    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');  
    $objWriter->save('php://output');
  }

}
?>